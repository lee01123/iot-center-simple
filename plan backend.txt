üìã K·∫ø ho·∫°ch Backend - Node.js + MongoDB
üèóÔ∏è Ki·∫øn tr√∫c t·ªïng quan
Frontend (React) ‚Üê‚Üí REST API (Express.js) ‚Üê‚Üí MongoDB Atlas
                    ‚Üï
                  MQTT Broker (Mosquitto/HiveMQ)
                    ‚Üï
              ESP8266/ESP32 Devices
üóÑÔ∏è Database Schema (MongoDB Collections)
1. devices - Th√¥ng tin thi·∫øt b·ªã


{
  _id: ObjectId,
  deviceId: String (unique),
  deviceName: String,
  deviceType: String, // "ESP8266_D1_MINI" | "ESP32_NANO"
  zone: String,
  line: String,
  process: String,
  equipment: String,
  status: String, // "online" | "offline"
  lastSeen: Date,
  createdAt: Date,
  updatedAt: Date,
  config: {
    dataSendInterval: { value: Number, unit: String },
    heartbeatInterval: { value: Number, unit: String }
  }
}
2. sensors - C·∫•u h√¨nh sensor


{
  _id: ObjectId,
  deviceId: String, // reference to devices
  sensorType: String, // "temperature" | "humidity" | "light" | "led_rgb"
  sensorName: String,
  pinMappings: [{
    sensorPin: String,
    devicePin: String
  }],
  measurementRange: {
    min: Number,
    max: Number,
    unit: String
  },
  errorMargin: Number,
  datasheetUrl: String,
  isActive: Boolean,
  createdAt: Date,
  updatedAt: Date
}
3. sensor_data - D·ªØ li·ªáu t·ª´ sensor (Time-series)


{
  _id: ObjectId,
  deviceId: String,
  sensorId: String,
  sensorType: String,
  value: Number,
  unit: String,
  quality: String, // "good" | "warning" | "error"
  timestamp: Date,
  metadata: {
    signalStrength: Number,
    batteryLevel: Number
  }
}
4. zones - Qu·∫£n l√Ω v√πng


{
  _id: ObjectId,
  zoneName: String,
  lines: [String],
  description: String,
  floorPlan: {
    imageUrl: String,
    coordinates: Object
  }
}
5. alerts - C·∫£nh b√°o


{
  _id: ObjectId,
  deviceId: String,
  sensorId: String,
  alertType: String, // "threshold" | "offline" | "error"
  severity: String, // "low" | "medium" | "high" | "critical"
  message: String,
  isResolved: Boolean,
  createdAt: Date,
  resolvedAt: Date
}
üîå API Endpoints
Device Management

POST /api/devices - T·∫°o device m·ªõi
GET /api/devices - L·∫•y danh s√°ch devices (filter: zone, line, status)
GET /api/devices/:id - Chi ti·∫øt device
PUT /api/devices/:id - C·∫≠p nh·∫≠t device
DELETE /api/devices/:id - X√≥a device
POST /api/devices/:id/config - C·∫≠p nh·∫≠t config (intervals)
Sensor Configuration

POST /api/sensors - Th√™m sensor cho device
GET /api/sensors?deviceId=xxx - L·∫•y sensors c·ªßa device
PUT /api/sensors/:id - C·∫≠p nh·∫≠t sensor config
DELETE /api/sensors/:id - X√≥a sensor
POST /api/sensors/bulk-import - Import JSON config
Sensor Data

POST /api/sensor-data - ESP g·ª≠i d·ªØ li·ªáu l√™n (from MQTT)
GET /api/sensor-data?deviceId=xxx&from=...&to=... - L·∫•y d·ªØ li·ªáu theo kho·∫£ng th·ªùi gian
GET /api/sensor-data/latest?deviceId=xxx - D·ªØ li·ªáu m·ªõi nh·∫•t
GET /api/sensor-data/statistics - Th·ªëng k√™ (min, max, avg)
Zone & Line

GET /api/zones - Danh s√°ch zones
GET /api/zones/:id/devices - Devices trong zone
POST /api/zones - T·∫°o zone m·ªõi
PUT /api/zones/:id - C·∫≠p nh·∫≠t zone
Alerts

GET /api/alerts?status=unresolved - Danh s√°ch c·∫£nh b√°o
POST /api/alerts/:id/resolve - ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω
GET /api/alerts/statistics - Th·ªëng k√™ c·∫£nh b√°o
üì° MQTT Integration
Topics Structure:

iot/{zone}/{line}/{deviceId}/data        - Device g·ª≠i data
iot/{zone}/{line}/{deviceId}/heartbeat   - Device heartbeat
iot/{zone}/{line}/{deviceId}/status      - Status updates
iot/{zone}/{line}/{deviceId}/config      - Server g·ª≠i config xu·ªëng
MQTT Handler (Node.js):


- Subscribe v√†o topics
- Parse message t·ª´ ESP
- Validate data
- L∆∞u v√†o MongoDB (sensor_data collection)
- Emit WebSocket event ƒë·∫øn frontend (real-time update)
- Check threshold ‚Üí t·∫°o alerts n·∫øu c·∫ßn
üîí Authentication & Authorization
JWT tokens cho user authentication
API Keys cho ESP devices
Role-based access: Admin, Operator, Viewer
üìä Real-time Communication
WebSocket (Socket.io) cho real-time dashboard updates
Events: device-status-change, new-sensor-data, alert-created
‚ö° Performance Optimization
Indexing MongoDB:

deviceId (unique index)
timestamp (sensor_data - ƒë·ªÉ query nhanh)
zone + line (composite index)
Caching (Redis):

Cache latest sensor values (TTL: dataSendInterval)
Cache device status
Cache zone/line metadata
Data Retention:

Raw data: 30 ng√†y
Aggregated data (hourly): 1 nƒÉm
Aggregated data (daily): vƒ©nh vi·ªÖn
üì¶ Tech Stack
- Runtime: Node.js v20+
- Framework: Express.js
- Database: MongoDB Atlas (ho·∫∑c self-hosted)
- MQTT Broker: Mosquitto / HiveMQ Cloud
- Cache: Redis (optional)
- WebSocket: Socket.io
- Authentication: JWT (jsonwebtoken)
- Validation: Joi / Zod
- ODM: Mongoose
üöÄ Deployment
Backend: Docker container ‚Üí AWS EC2 / DigitalOcean / Railway
MongoDB: MongoDB Atlas (free tier M0)
MQTT Broker: HiveMQ Cloud (free tier) ho·∫∑c self-hosted Mosquitto
